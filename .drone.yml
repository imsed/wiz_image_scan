kind: pipeline
type: kubernetes
name: wizcli-pipeline



services:
- name: docker
  image: docker:dind
  volumes:
  - name: dockersock
    path: /var/run

steps:
- name: build
  image: docker
  environment:
    DOCKER_HOST: tcp://localhost:2375
  commands:
  - docker build -t ${DRONE_REPO_NAME}:${DRONE_COMMIT_SHA} .
  volumes:
  - name: dockersock
    path: /var/run

- name: scan
  image: wiziocli.azurecr.io/wizcli:latest
  commands:
  - /entrypoint auth --id $WIZ_CLIENT_ID --secret $WIZ_CLIENT_SECRET 
  - docker save my-image > my-image.tar
  - /entrypoint docker scan  -p $WIZ_POLICY  --image my-image.tar
  environment:
    WIZ_POLICY: imsed-mis-policy
    WIZ_CLIENT_ID:
      from_secret: WIZ_CLIENT_ID
    WIZ_CLIENT_SECRET:
      from_secret: WIZ_CLIENT_SECRET
  volumes:
  - name: dockersock
    path: /var/run

volumes:
- name: dockersock
  temp: {}





